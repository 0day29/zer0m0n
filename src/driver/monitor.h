#ifndef __MONITOR_H
#define __MONITOR_H

#include <fltkernel.h>

/////////////////////////////////////////////////////////////////////////////
// STRUCTS
/////////////////////////////////////////////////////////////////////////////

// processes linked list
typedef struct _PROCESS_ENTRY
{
    LIST_ENTRY entry;
    ULONG pid;
} PROCESS_ENTRY, *PPROCESS_ENTRY;

// file handle linked list
typedef struct _HANDLE_ENTRY
{
    LIST_ENTRY entry;
    HANDLE handle;
} HANDLE_ENTRY, *PHANDLE_ENTRY;


/////////////////////////////////////////////////////////////////////////////
// GLOBALS
/////////////////////////////////////////////////////////////////////////////

// monitored processes list
PLIST_ENTRY pMonitoredProcessListHead;

// processes list to be hidden
PLIST_ENTRY pHiddenProcessListHead;

// file handle list
PLIST_ENTRY pHandleListHead;


/////////////////////////////////////////////////////////////////////////////
// FUNCTIONS
/////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////////////////////////
//  Description :
//      Initialize the linked lists
//  Parameters :
//      None
//  Return value :
//      NTSTATUS : STATUS_SUCCESS if no error occured, otherwise returns the relevant NTSTATUS code
//////////////////////////////////////////////////////////////////////////////////////////////////////////////
NTSTATUS Init_LinkedLists(VOID);

//////////////////////////////////////////////////////////////////////////////////////////////////////////////
//  Description :
//      Allocate a new node for a process linked list
//  Parameters :
//      __in ULONG new_pid : PID to add to the list
//  Return value :
//      PPROCESS_ENTRY : an allocated PROCESS_ENTRY or NULL if an error occured      
//////////////////////////////////////////////////////////////////////////////////////////////////////////////
PPROCESS_ENTRY AllocateProcessEntry(__in ULONG new_pid);

//////////////////////////////////////////////////////////////////////////////////////////////////////////////
//  Description :
//      Allocate a new node for a process linked list
//  Parameters :
//      __in HANDLE new_handle : handle to add to the list
//  Return value :
//      PHANDLE_ENTRY : an allocated HANLE_ENTRY or NULL if an error occured
//////////////////////////////////////////////////////////////////////////////////////////////////////////////
PHANDLE_ENTRY AllocateHandleEntry(__in HANDLE new_handle);

//////////////////////////////////////////////////////////////////////////////////////////////////////////////
//  Description :
//      Add a new process to monitor in the list 
//  Parameters :
//      __in ULONG new_pid : pid to add to the list
//  Return value :
//      NTSTATUS : STATUS_SUCCESS if no error occured, otherwise returns the relevant NTSTATUS code
//////////////////////////////////////////////////////////////////////////////////////////////////////////////
NTSTATUS StartMonitoringProcess(__in ULONG new_pid);

//////////////////////////////////////////////////////////////////////////////////////////////////////////////
//  Description :
//      Add a new process to hide in the list 
//  Parameters :
//      __in ULONG new_pid : pid to add to the list
//  Return value :
//      NTSTATUS : STATUS_SUCCESS if no error occured, otherwise returns the relevant NTSTATUS code
//////////////////////////////////////////////////////////////////////////////////////////////////////////////
NTSTATUS AddProcessToHideToList(__in ULONG new_pid);

//////////////////////////////////////////////////////////////////////////////////////////////////////////////
//  Description :
//      Add a new handle to monitor in the list 
//  Parameters :
//      __in ULONG new_handle : new_handle to add in the list
//  Return value :
//      NTSTATUS : STATUS_SUCCESS if no error occured, otherwise returns the relevant NTSTATUS code
//////////////////////////////////////////////////////////////////////////////////////////////////////////////
NTSTATUS AddHandleToList(__in HANDLE new_handle);

//////////////////////////////////////////////////////////////////////////////////////////////////////////////
//  Description :
//      Removes handle from the list (stop monitoring this handle) 
//  Parameters :
//      __in ULONG handle : handle to remove from the monitored handle list 
//  Return value :
//      NTSTATUS : STATUS_SUCCESS if no error occured, otherwise, relevant NTSTATUS code
//////////////////////////////////////////////////////////////////////////////////////////////////////////////
NTSTATUS RemoveHandleFromList(__in HANDLE handle);

//////////////////////////////////////////////////////////////////////////////////////////////////////////////
//  Description :
//      Checks if a process is in a linked list 
//  Parameters :
//      __in ULONG pid : process identifier to check for
//      __in PLIST_ENTRY pListHead : linked list to check in
//  Return value :
//      BOOLEAN : TRUE if found, FALSE if not 
//  Process :
//      Walks through the linked list, returns TRUE if the process is found 
//////////////////////////////////////////////////////////////////////////////////////////////////////////////
BOOLEAN IsProcessInList(__in ULONG pid, 
                        __in PLIST_ENTRY pListHead);

//////////////////////////////////////////////////////////////////////////////////////////////////////////////
//  Description :
//      Checks if a handle is in a linked list 
//  Parameters :
//      __in HANDLE handle : handle to check for
//      __in PLIST_ENTRY pListHead : linked list to check in
//  Return value :
//      BOOLEAN : TRUE if found, FALSE if not 
//////////////////////////////////////////////////////////////////////////////////////////////////////////////
BOOLEAN IsHandleInList(__in HANDLE handle);

//////////////////////////////////////////////////////////////////////////////////////////////////////////////
//  Description :
//      Remove the entries from every linked list 
//  Parameters :
//      None
//  Return value :
//      None
//////////////////////////////////////////////////////////////////////////////////////////////////////////////
VOID FreeList(VOID);

//////////////////////////////////////////////////////////////////////////////////////////////////////////////
//  Description :
//      Displays each entries from the linked listed 
//  Parameters :
//      None
//  Return value :
//      None
//////////////////////////////////////////////////////////////////////////////////////////////////////////////
VOID Dbg_WalkList(VOID);

#endif
